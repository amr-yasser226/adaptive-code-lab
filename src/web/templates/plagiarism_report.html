{% extends "base.html" %}

{% block title %}Similarity Detection - ACCL{% endblock %}

{% block content %}
<!-- Purple Gradient Header -->
<div class="plagiarism-header mb-5">
    <div class="container-fluid">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="plagiarism-title">
                    <i class="fas fa-shield-alt"></i> Similarity Detection Dashboard
                </h1>
                <p class="plagiarism-subtitle">AI-powered plagiarism and code similarity analysis</p>
            </div>
            <div class="col-md-4 text-end">
                <i class="fas fa-lock plagiarism-icon-large"></i>
            </div>
        </div>
    </div>
</div>

<!-- Alert Banner -->
<div class="alert alert-warning alert-dismissible fade show" role="alert">
    <i class="fas fa-exclamation-circle"></i>
    <strong>Potential Academic Integrity Violations Detected</strong>
    <p class="mb-0">3 submissions flagged with high similarity scores requiring review</p>
    <button type="button" class="btn btn-sm btn-danger float-end"
        onclick="document.querySelector('.similarity-card').scrollIntoView({behavior: 'smooth'})"><i
            class="fas fa-arrow-right"></i> Review All
        â†’</button>
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>

<!-- Analysis Overview Cards -->
<div class="row mb-4">
    <div class="col-md-3 mb-3">
        <div class="overview-card overview-card-blue">
            <i class="fas fa-chart-bar"></i>
            <h3>147</h3>
            <p>Total Scans</p>
        </div>
    </div>

    <div class="col-md-3 mb-3">
        <div class="overview-card overview-card-red">
            <i class="fas fa-exclamation"></i>
            <h3>3 (2%)</h3>
            <p>High Similarity</p>
        </div>
    </div>

    <div class="col-md-3 mb-3">
        <div class="overview-card overview-card-yellow">
            <i class="fas fa-bolt"></i>
            <h3>12 (8%)</h3>
            <p>Medium Similarity</p>
        </div>
    </div>

    <div class="col-md-3 mb-3">
        <div class="overview-card overview-card-green">
            <i class="fas fa-check"></i>
            <h3>132 (90%)</h3>
            <p>Low Similarity</p>
        </div>
    </div>
</div>

<!-- Filter and Sort Controls -->
<div class="filter-controls mb-4">
    <div class="row align-items-center">
        <div class="col-md-8">
            <div class="btn-group" role="group">
                <a href="{{ url_for('instructor.plagiarism_dashboard') }}"
                    class="btn btn-{{ 'primary' if not request.args.get('severity') else 'outline-primary' }}">All</a>
                <a href="{{ url_for('instructor.plagiarism_dashboard', severity='high') }}"
                    class="btn btn-{{ 'primary' if request.args.get('severity') == 'high' else 'outline-primary' }}">High</a>
                <a href="{{ url_for('instructor.plagiarism_dashboard', severity='medium') }}"
                    class="btn btn-{{ 'primary' if request.args.get('severity') == 'medium' else 'outline-primary' }}">Medium</a>
                <a href="{{ url_for('instructor.plagiarism_dashboard', severity='low') }}"
                    class="btn btn-{{ 'primary' if request.args.get('severity') == 'low' else 'outline-primary' }}">Low</a>
            </div>
        </div>
        <div class="col-md-4 text-end">
            <button class="btn btn-outline-secondary"><i class="fas fa-sort"></i> Sort by Score</button>
            <button class="btn btn-outline-secondary"><i class="fas fa-download"></i> Export Report</button>
            <button class="btn btn-outline-secondary"><i class="fas fa-cog"></i> Settings</button>
        </div>
    </div>
</div>

<!-- Similarity Detection Cards -->
<div class="row">
    <div class="col-md-12">
        {% if flagged_pairs %}
        {% for pair in flagged_pairs %}
        <!-- Dynamic Similarity Card -->
        <div
            class="similarity-card {% if pair.similarity_score > 0.8 %}similarity-card-high{% elif pair.similarity_score > 0.5 %}similarity-card-medium{% else %}similarity-card-low{% endif %} mb-3">
            <div class="similarity-card-header">
                <div class="similarity-badge">
                    {% if pair.similarity_score > 0.8 %}
                    <i class="fas fa-exclamation-circle"></i> HIGH SIMILARITY DETECTED
                    {% elif pair.similarity_score > 0.5 %}
                    <i class="fas fa-exclamation"></i> MEDIUM SIMILARITY DETECTED
                    {% else %}
                    <i class="fas fa-info-circle"></i> LOW SIMILARITY DETECTED
                    {% endif %}
                </div>
                <div class="similarity-score">{{ "%.0f"|format(pair.similarity_score * 100) }}% Match</div>
            </div>
            <div class="similarity-card-body">
                <div class="comparison-pair">
                    <div class="submission-compared">
                        <h6>Student: {{ pair.student_name }}</h6>
                        <p><i class="fas fa-file-code"></i> Submission ID: {{ pair.submission_id }}</p>
                        <p><i class="fas fa-flag"></i> Status: <span
                                class="badge {% if pair.status == 'pending' %}bg-warning{% else %}bg-info{% endif %}">{{
                                pair.status|capitalize }}</span></p>
                    </div>
                    <div class="vs-badge">VS</div>
                    <div class="submission-compared">
                        <h6>Matched Submission</h6>
                        <p><i class="fas fa-file-code"></i> Submission ID: {{ pair.matched_submission_id }}</p>
                        {% if pair.created_at %}
                        <p><i class="fas fa-calendar"></i> Flagged: {{ pair.created_at }}</p>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="similarity-card-footer">
                <a href="{{ url_for('instructor.plagiarism_compare', pair_id=pair.id) }}"
                    class="btn btn-sm {% if pair.similarity_score > 0.8 %}btn-danger{% elif pair.similarity_score > 0.5 %}btn-warning{% else %}btn-success{% endif %}">
                    <i class="fas fa-eye"></i> View Detailed Comparison
                </a>
                <!-- Review Actions -->
                <div class="btn-group ms-2">
                    <form action="{{ url_for('instructor.plagiarism_review', flag_id=pair.id) }}" method="POST"
                        style="display: inline;">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                        <input type="hidden" name="action" value="dismiss" />
                        <button type="submit" class="btn btn-sm btn-outline-success"
                            onclick="return confirm('Dismiss this flag?')">
                            <i class="fas fa-check"></i> Dismiss
                        </button>
                    </form>
                    <form action="{{ url_for('instructor.plagiarism_review', flag_id=pair.id) }}" method="POST"
                        style="display: inline;">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                        <input type="hidden" name="action" value="approve" />
                        <button type="submit" class="btn btn-sm btn-outline-danger"
                            onclick="return confirm('Confirm this as plagiarism?')">
                            <i class="fas fa-exclamation-triangle"></i> Confirm
                        </button>
                    </form>
                </div>
            </div>
        </div>
        {% endfor %}
        {% else %}
        <!-- No flags message -->
        <div class="alert alert-success" role="alert">
            <i class="fas fa-check-circle"></i> No similarity flags to review. All submissions appear to be original
            work.
        </div>
        {% endif %}
    </div>
</div>

<!-- Analysis Summary Section -->
<div class="card border-0 bg-light mt-4">
    <div class="card-body p-4">
        <h3><i class="fas fa-book"></i> Analysis Summary & Insights</h3>
        <div class="insights-grid mt-3">
            <div class="insight-item">
                <i class="fas fa-microscope"></i>
                <p>Detection Method: AI-powered code structure analysis + string matching</p>
            </div>
            <div class="insight-item">
                <i class="fas fa-database"></i>
                <p>Database: Compared against 25,847 student submissions + 1.2M online sources</p>
            </div>
            <div class="insight-item">
                <i class="fas fa-sliders-h"></i>
                <p>Threshold Settings: High (>80%), Medium (60-80%), Low (<60%)< /p>
            </div>
            <div class="insight-item">
                <i class="fas fa-chart-line"></i>
                <p>False Positive Rate: 1.2% (based on manual review)</p>
            </div>
            <div class="insight-item">
                <i class="fas fa-clock"></i>
                <p>Last Full Scan: Nov 19, 2025 at 2:34 AM (147 submissions analyzed)</p>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-8">
        <h1>
            <i class="fas fa-exclamation-triangle"></i> Plagiarism Detection
        </h1>
        <p class="text-muted">Compare submissions for similarity</p>
    </div>
</div><!-- Similarity Pairs List -->
{% if similarities %}
<div class="row">
    {% for pair in similarities %}
    <div class="col-md-12 mb-4">
        <div
            class="card {% if pair.similarity_score > 75 %}border-danger{% elif pair.similarity_score > 50 %}border-warning{% else %}border-success{% endif %}">
            <div
                class="card-header {% if pair.similarity_score > 75 %}bg-danger{% elif pair.similarity_score > 50 %}bg-warning{% else %}bg-success{% endif %} text-white">
                <div class="row align-items-center">
                    <div class="col">
                        <h5 class="mb-0">
                            <i class="fas fa-users"></i>
                            {{ pair.submission1.student.name }}
                            <i class="fas fa-exchange-alt"></i>
                            {{ pair.submission2.student.name }}
                        </h5>
                    </div>
                    <div class="col-auto">
                        <h4 class="mb-0">{{ "%.1f"|format(pair.similarity_score) }}%</h4>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <strong>Submission 1</strong>
                        <p class="small text-muted">
                            {{ pair.submission1.student.name }}<br>
                            Submitted: {{ pair.submission1.submitted_at|format_date('%b %d, %Y') }}
                        </p>
                    </div>
                    <div class="col-md-6">
                        <strong>Submission 2</strong>
                        <p class="small text-muted">
                            {{ pair.submission2.student.name }}<br>
                            Submitted: {{ pair.submission2.submitted_at|format_date('%b %d, %Y') }}
                        </p>
                    </div>
                </div>

                <!-- Matching Snippets -->
                {% if pair.matching_blocks %}
                <h6 class="mb-3">Matching Code Snippets</h6>
                {% for block in pair.matching_blocks[:3] %}
                <div class="mb-3">
                    <small class="text-muted">Match {{ loop.index }}: {{ "%.1f"|format(block.similarity * 100) }}%
                        similar</small>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="bg-light p-2 rounded border"
                                style="font-family: monospace; font-size: 0.85em; max-height: 100px; overflow: hidden;">
                                {{ block.code1[:150] }}...
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="bg-light p-2 rounded border"
                                style="font-family: monospace; font-size: 0.85em; max-height: 100px; overflow: hidden;">
                                {{ block.code2[:150] }}...
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
                {% endif %}
            </div>
            <div class="card-footer">
                <a href="#" class="btn btn-sm btn-primary">
                    <i class="fas fa-eye"></i> Detailed Comparison
                </a>
                <button class="btn btn-sm btn-outline-danger" onclick="markAsFalsePositive('{{ pair.id }}')">
                    <i class="fas fa-check"></i> Mark as False Positive
                </button>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<div class="alert alert-info" role="alert">
    <i class="fas fa-info-circle"></i> No suspicious similarities found above the threshold.
</div>
{% endif %}

<!-- Legend -->
<div class="row mt-4">
    <div class="col-md-12">
        <div class="card bg-light">
            <div class="card-body">
                <h6>Similarity Score Legend</h6>
                <div class="row">
                    <div class="col-md-4">
                        <span class="badge bg-danger">75%+</span>
                        <span class="ms-2">Very High - Requires Investigation</span>
                    </div>
                    <div class="col-md-4">
                        <span class="badge bg-warning">50-74%</span>
                        <span class="ms-2">High - Review Recommended</span>
                    </div>
                    <div class="col-md-4">
                        <span class="badge bg-success">
                            < 50%</span>
                                <span class="ms-2">Low - Likely Independent Work</span>
                    </div>
                </div>
                <p class="small text-muted mt-2 mb-0">
                    <strong>Note:</strong> This tool is for advisory purposes only. Similar code does not necessarily
                    indicate plagiarism
                    as students may legitimately arrive at similar solutions.
                </p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

<script>
    function markAsFalsePositive(pairId) {
        if (confirm('Mark this pair as a false positive?')) {
            fetch('{{ url_for("plagiarism.mark_false_positive") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({ pair_id: pairId })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    }
                });
        }
    }
</script>