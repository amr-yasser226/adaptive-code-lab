{% extends "base.html" %}

{% block title %}Submission Results - {{ assignment.title }} - ACCL{% endblock %}

{% block content %}
<!-- Breadcrumb Navigation -->
<nav aria-label="breadcrumb" class="mb-4">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{{ url_for('index') }}"><i class="fas fa-home"></i> Home</a></li>
        <li class="breadcrumb-item"><a href="{{ url_for('student.assignments') }}"><i class="fas fa-list"></i>
                Assignments</a></li>
        <li class="breadcrumb-item"><a
                href="{{ url_for('student.assignment_detail', assignment_id=assignment.get_id()) }}">{{ assignment.title
                }}</a></li>
        <li class="breadcrumb-item active" aria-current="page">Submission Results</li>
    </ol>
</nav>

<!-- Result Header -->
<div
    class="results-header mb-4 p-4 rounded shadow-sm {% if submission.status == 'graded' and submission.score >= 70 %}bg-success text-white{% elif submission.status == 'graded' and submission.score < 70 %}bg-warning text-dark{% elif submission.status == 'failed' or submission.status == 'error' %}bg-danger text-white{% else %}bg-info text-white{% endif %}">
    <div class="row align-items-center">
        <div class="col-md-8">
            <h2 class="mb-1">
                {% if submission.status == 'graded' %}
                {% if submission.score >= 70 %}
                <i class="fas fa-check-circle"></i> Submission Passed
                {% else %}
                <i class="fas fa-exclamation-circle"></i> Submission Graded
                {% endif %}
                {% elif submission.status == 'failed' or submission.status == 'error' %}
                <i class="fas fa-times-circle"></i> Submission Failed
                {% else %}
                <i class="fas fa-spinner fa-spin"></i> Processing Submission
                {% endif %}
            </h2>
            <p class="mb-0 opacity-75">
                Version {{ submission.version }} - {{ assignment.title }}
            </p>
        </div>
        <div class="col-md-4 text-md-end mt-3 mt-md-0">
            {% if submission.status == 'graded' %}
            <div class="h3 mb-0">Score: {{ submission.score }}/100</div>
            {% else %}
            <div class="h3 mb-0">Status: {{ submission.status|capitalize }}</div>
            {% endif %}
        </div>
    </div>
</div>

<div class="row">
    <!-- Main Results Column -->
    <div class="col-lg-8">
        <!-- Test Results Table/Accordion -->
        <div class="card mb-4 shadow-sm">
            <div class="card-header bg-white">
                <h5 class="mb-0"><i class="fas fa-flask"></i> Test Cases</h5>
            </div>
            <div class="card-body">
                {% if test_results %}
                <div class="accordion" id="testAccordion">
                    {% for result in test_results %}
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="heading{{ loop.index }}">
                            <button
                                class="accordion-button {% if not loop.first %}collapsed{% endif %} {% if result.passed %}bg-light{% else %}bg-danger bg-opacity-10{% endif %}"
                                type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ loop.index }}">
                                <div class="d-flex justify-content-between w-100 me-3">
                                    <span>
                                        {% if result.passed %}
                                        <i class="fas fa-check-circle text-success me-2"></i>
                                        {% else %}
                                        <i class="fas fa-times-circle text-danger me-2"></i>
                                        {% endif %}
                                        Test Case #{{ loop.index }}
                                    </span>
                                    <span class="badge {% if result.passed %}bg-success{% else %}bg-danger{% endif %}">
                                        {{ 'PASSED' if result.passed else 'FAILED' }}
                                    </span>
                                </div>
                            </button>
                        </h2>
                        <div id="collapse{{ loop.index }}"
                            class="accordion-collapse collapse {% if loop.first %}show{% endif %}"
                            data-bs-parent="#testAccordion">
                            <div class="accordion-body">
                                <div class="row g-3">
                                    <div class="col-12">
                                        <h6>Input:</h6>
                                        <pre
                                            class="bg-light p-2 rounded"><code>{{ result.test_case.input if result.test_case else 'N/A' }}</code></pre>
                                    </div>
                                    <div class="col-md-6">
                                        <h6>Expected Output:</h6>
                                        <pre
                                            class="bg-light p-2 rounded"><code>{{ result.test_case.expected_output if result.test_case else 'N/A' }}</code></pre>
                                    </div>
                                    <div class="col-md-6">
                                        <h6>Your Output:</h6>
                                        <pre
                                            class="{% if result.passed %}bg-light{% else %}bg-danger bg-opacity-10{% endif %} p-2 rounded"><code>{{ result.stdout if result.stdout else '(no output)' }}</code></pre>
                                    </div>
                                    {% if result.stderr %}
                                    <div class="col-12">
                                        <h6 class="text-danger">Error:</h6>
                                        <pre
                                            class="bg-dark text-white p-2 rounded"><code>{{ result.stderr }}</code></pre>
                                    </div>
                                    {% endif %}
                                    <div class="col-12 mt-2">
                                        <small class="text-muted"><i class="fas fa-clock"></i> Runtime: {{
                                            result.runtime_ms }}ms</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-info-circle fa-2x text-muted mb-2"></i>
                    <p class="text-muted">No specific test results available. If this assignment is auto-graded, results
                        will appear here shortly.</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- AI Recommendations / Hints -->
        {% if submission.hints or submission.status == 'failed' %}
        <div class="card mb-4 border-0 shadow-sm bg-light">
            <div class="card-header bg-warning text-dark border-0">
                <h5 class="mb-0"><i class="fas fa-lightbulb"></i> Learning Resources & Hints</h5>
            </div>
            <div class="card-body">
                {% if submission.hints %}
                {% for hint in submission.hints %}
                <div class="alert alert-info border-0 shadow-sm">
                    <h6>Hint (Level {{ hint.level }})</h6>
                    <p class="mb-0">{{ hint.content }}</p>
                </div>
                {% endfor %}
                {% else %}
                <p>Based on your submission, we recommend checking your logic for common edge cases. Visit your <a
                        href="{{ url_for('remediation.list_remediations') }}">Learning Resources</a> for personalized
                    content.</p>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <!-- Peer Review Form (for assigned reviewers) -->
        {% if assigned_review and not is_owner %}
        <div class="card mb-4 border-0 shadow-sm">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="fas fa-user-edit"></i> Peer Review</h5>
            </div>
            <div class="card-body">
                <form
                    action="{{ url_for('peer_review.update_review' if assigned_review.rubric_score or assigned_review.comments else 'peer_review.create_review', submission_id=submission.get_id()) }}"
                    method="POST">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />

                    <div class="mb-3">
                        <label class="form-label font-weight-bold">Rubric Score (0-10)</label>
                        <input type="number" name="rubric_score" class="form-control" min="0" max="10" step="1"
                            value="{{ assigned_review.rubric_score if assigned_review.rubric_score is number else '' }}"
                            required>
                        <small class="text-muted">Provide an overall score based on the assignment requirements.</small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label font-weight-bold">Comments & Feedback</label>
                        <textarea name="comments" class="form-control" rows="5"
                            placeholder="What did they do well? What could be improved?"
                            required>{{ assigned_review.comments or '' }}</textarea>
                    </div>

                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary px-4">
                            <i class="fas fa-save me-1"></i> Save Draft
                        </button>
                        {% if not assigned_review.is_submitted %}
                        <button type="submit" form="submitReviewForm" class="btn btn-success px-4" {{ 'disabled' if
                            assigned_review.rubric_score is none or not assigned_review.comments }}>
                            <i class="fas fa-check-circle me-1"></i> Submit Review
                        </button>
                        {% endif %}
                    </div>
                </form>

                {% if not assigned_review.is_submitted %}
                <form id="submitReviewForm"
                    action="{{ url_for('peer_review.submit_review', submission_id=submission.get_id()) }}" method="POST"
                    style="display:none;">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                </form>
                {% endif %}

                {% if assigned_review.is_submitted %}
                <div class="alert alert-success mt-3 mb-0">
                    <i class="fas fa-check-double me-2"></i> This review has been submitted and can no longer be edited.
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Sidebar Column -->
    <div class="col-lg-4">
        <!-- Submission details -->
        <div class="card mb-4 shadow-sm">
            <div class="card-header bg-white">
                <h5 class="mb-0"><i class="fas fa-info-circle"></i> Info</h5>
            </div>
            <div class="card-body">
                <dl class="row mb-0">
                    <dt class="col-5">Status</dt>
                    <dd class="col-7"><span
                            class="badge {% if submission.status == 'graded' %}bg-success{% else %}bg-info{% endif %}">{{
                            submission.status|capitalize }}</span></dd>

                    <dt class="col-5">Language</dt>
                    <dd class="col-7">{{ submission.language|capitalize }}</dd>

                    <dt class="col-5">Submitted</dt>
                    <dd class="col-7 small">{{ submission.created_at|format_date('%b %d, %Y %I:%M %p') if
                        submission.created_at else 'N/A' }}</dd>

                    {% if submission.grade_at %}
                    <dt class="col-5">Graded At</dt>
                    <dd class="col-7 small">{{ submission.grade_at|format_date('%b %d, %Y %I:%M %p') }}</dd>
                    {% endif %}

                    <dt class="col-5">Points</dt>
                    <dd class="col-7"><strong>{{ submission.score or 0 }}/100</strong></dd>
                </dl>
            </div>
            <div class="card-footer bg-white border-top-0">
                <a href="{{ url_for('student.submit_code', assignment_id=assignment.get_id()) }}"
                    class="btn btn-primary w-100 mb-2">
                    <i class="fas fa-redo"></i> Submit New Version
                </a>
                <a href="{{ url_for('student.assignment_detail', assignment_id=assignment.get_id()) }}"
                    class="btn btn-outline-secondary w-100">
                    <i class="fas fa-arrow-left"></i> Back to Assignment
                </a>
            </div>
        </div>

        <!-- Code Preview (Simplified) -->
        <div class="card shadow-sm">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-code"></i> Submitted Code</h5>
                <button class="btn btn-sm btn-outline-primary" onclick="copyCode()">Copy</button>
            </div>
            <div class="card-body p-0">
                <pre class="mb-0 p-3 bg-dark text-white"
                    style="max-height: 400px; overflow-y: auto; font-size: 0.85rem;"><code id="submittedCode">{{ submission.content or '# No code content stored' }}</code></pre>
            </div>
        </div>
    </div>
</div>

<script>
    function copyCode() {
        const code = document.getElementById('submittedCode').textContent;
        navigator.clipboard.writeText(code).then(() => {
            alert('Code copied to clipboard!');
        });
    }
</script>
{% endblock %}