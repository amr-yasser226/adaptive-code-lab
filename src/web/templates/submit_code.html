{% extends "base.html" %}

{% block title %}Submit Code - {{ assignment.title }} - ACCL{% endblock %}

{% block content %}
<!-- Breadcrumb Navigation -->
<nav aria-label="breadcrumb" class="mb-3">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{{ url_for('index') }}"><i class="fas fa-home"></i> Home</a></li>
        <li class="breadcrumb-item"><a href="{{ url_for('student.assignments') }}"><i class="fas fa-list"></i>
                Assignments</a></li>
        <li class="breadcrumb-item"><a
                href="{{ url_for('student.assignment_detail', assignment_id=assignment.get_id()) }}">{{ assignment.title
                }}</a></li>
        <li class="breadcrumb-item active" aria-current="page">Submit Code</li>
    </ol>
</nav>

<!-- Submit Header -->
<div class="submit-header mb-4"
    style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; padding: 1.5rem 2rem; color: white;">
    <div class="row align-items-center">
        <div class="col-md-8">
            <h1 class="mb-1" style="color: white; font-size: 1.75rem;">
                <i class="fas fa-code"></i> Submit Code
            </h1>
            <p class="mb-0" style="color: rgba(255,255,255,0.9);">{{ assignment.title }}</p>
        </div>
        <div class="col-md-4 text-end">
            <span class="badge" style="font-size: 0.95rem; padding: 0.6rem 1.2rem; background: rgba(255,255,255,0.2);">
                <i class="fas fa-flask"></i> Testing Available
            </span>
        </div>
    </div>
</div>

<div class="row">
    <!-- Code Editor Area (Main) -->
    <div class="col-lg-8">
        <div class="submission-editor-card shadow-sm border-0 mb-4"
            style="border-radius: 12px; overflow: hidden; background: white;">
            <div class="editor-header bg-light p-3 border-bottom">
                <div class="row align-items-center">
                    <div class="col">
                        <h5 class="mb-0 text-dark"><i class="fas fa-keyboard me-2"></i>Code Editor</h5>
                    </div>
                    <div class="col-auto">
                        <small class="text-muted">
                            <i class="fas fa-history me-1"></i> Version <span id="versionNumber">{{
                                previous_submissions|length + 1 }}</span>
                        </small>
                    </div>
                </div>
            </div>

            <div class="editor-body p-4">
                <form method="POST" action="{{ url_for('student.submit_code', assignment_id=assignment.get_id()) }}"
                    id="codeForm">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />

                    <!-- Language & Toolbar -->
                    <div class="editor-toolbar mb-3 p-2 bg-light border rounded">
                        <div class="row g-2 align-items-center">
                            <div class="col-md-4">
                                <select name="language" class="form-select form-select-sm" id="language" required>
                                    <option value="python" selected>Python 3.11</option>
                                    <option value="java">Java 17</option>
                                    <option value="cpp">C++ 17</option>
                                    <option value="javascript">JavaScript (Node.js)</option>
                                    <option value="csharp">C# (.NET)</option>
                                </select>
                            </div>
                            <div class="col-md-8 text-end">
                                <div class="btn-group btn-group-sm">
                                    <button type="button" class="btn btn-outline-primary" onclick="formatCode()">
                                        <i class="fas fa-align-left me-1"></i>Format
                                    </button>
                                    <button type="button" class="btn btn-outline-info" id="dryRunBtn"
                                        onclick="runDryRun()">
                                        <i class="fas fa-flask me-1"></i>Test Code
                                    </button>
                                    <button type="button" class="btn btn-outline-warning" id="hintBtn"
                                        onclick="requestAiHint()">
                                        <i class="fas fa-lightbulb me-1"></i>AI Hint
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Editor Textarea -->
                    <div class="position-relative">
                        <textarea name="code" id="code" class="form-control code-editor-textarea" spellcheck="false"
                            placeholder="Write your solution here..."
                            style="min-height: 450px; font-family: 'Fira Code', monospace; font-size: 14px; background: #f8f9fa;">{{ initial_code or '' }}</textarea>
                        <div class="editor-footer d-flex justify-content-between px-2 py-1 bg-dark text-white-50 small border-top"
                            style="border-bottom-left-radius: 4px; border-bottom-right-radius: 4px;">
                            <span>Lines: <span id="lineCount">1</span></span>
                            <span>Chars: <span id="charCount">0</span></span>
                        </div>
                    </div>

                    <!-- Results Panel -->
                    <div id="resultsPanel" class="mt-4 border rounded shadow-sm d-none">
                        <div
                            class="card-header bg-dark text-white d-flex justify-content-between align-items-center py-2">
                            <h6 class="mb-0 small font-weight-bold"><i class="fas fa-terminal me-2"></i>Execution
                                Results</h6>
                            <button type="button" class="btn-close btn-close-white btn-sm"
                                onclick="hideResults()"></button>
                        </div>
                        <div class="card-body bg-light p-0">
                            <ul class="nav nav-tabs px-3 pt-2 bg-white" id="resultTabs" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active py-1 small" id="test-results-tab"
                                        data-bs-toggle="tab" data-bs-target="#test-results" type="button"
                                        role="tab">Test Cases</button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link py-1 small" id="ai-hint-tab" data-bs-toggle="tab"
                                        data-bs-target="#ai-hint" type="button" role="tab">AI Hint</button>
                                </li>
                            </ul>
                            <div class="tab-content" id="resultTabsContent">
                                <div class="tab-pane fade show active" id="test-results" role="tabpanel">
                                    <div id="testResultsList" class="p-0">
                                        <div class="p-4 text-center text-muted">
                                            <i class="fas fa-play-circle fa-2x mb-2 d-block opacity-25"></i>
                                            <p class="mb-0">Run "Test Code" to see results here.</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="tab-pane fade" id="ai-hint" role="tabpanel">
                                    <div id="aiHintContent" class="p-3">
                                        <div class="p-4 text-center text-muted">
                                            <i class="fas fa-brain fa-2x mb-2 d-block opacity-25"></i>
                                            <p class="mb-0">Run tests or click "AI Hint" to get guidance.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- File Upload & Actions -->
                    <div class="mt-4 pt-3 border-top">
                        <div class="row align-items-center">
                            <div class="col-md-6 mb-3 mb-md-0">
                                <div class="d-flex align-items-center gap-3">
                                    <button type="button" class="btn btn-outline-secondary btn-sm"
                                        onclick="document.getElementById('file_upload').click()">
                                        <i class="fas fa-cloud-upload-alt me-1"></i>Upload File
                                    </button>
                                    <input type="file" id="file_upload" class="d-none"
                                        onchange="handleFileUpload(this)">
                                    <span id="fileName" class="text-muted small">No file chosen</span>
                                </div>
                            </div>
                            <div class="col-md-6 text-md-end">
                                <a href="{{ url_for('student.assignment_detail', assignment_id=assignment.get_id()) }}"
                                    class="btn btn-link text-muted me-2">Cancel</a>
                                <button type="submit" class="btn btn-primary px-4">
                                    <i class="fas fa-paper-plane me-2"></i>Submit Solution
                                </button>
                            </div>
                        </div>
                        <div class="mt-3 d-flex align-items-center">
                            <span id="autosaveStatus" class="autosave-status me-2"></span>
                            <small class="text-muted"><i class="fas fa-info-circle me-1"></i>Your progress is
                                automatically saved as a draft.</small>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Submission Tips -->
        <div class="card border-0 shadow-sm mt-4" style="border-radius: 12px;">
            <div class="card-header bg-white py-3">
                <h5 class="mb-0 text-dark"><i class="fas fa-lightbulb text-warning me-2"></i>Submission Tips</h5>
            </div>
            <div class="card-body">
                <ul class="list-unstyled mb-0">
                    <li class="mb-2 d-flex align-items-start">
                        <i class="fas fa-check-circle text-success mt-1 me-2"></i>
                        <span>Test your code using the <strong>Test Code</strong> button before final submission.</span>
                    </li>
                    <li class="mb-2 d-flex align-items-start">
                        <i class="fas fa-check-circle text-success mt-1 me-2"></i>
                        <span>You can submit multiple times; only your <strong>latest</strong> submission counts toward
                            your grade.</span>
                    </li>
                    <li class="d-flex align-items-start">
                        <i class="fas fa-check-circle text-success mt-1 me-2"></i>
                        <span>Stuck? Use <strong>AI Hint</strong> for conceptual guidance without spoilers.</span>
                    </li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="col-lg-4">
        <!-- Assignment Stats -->
        <div class="card border-0 shadow-sm mb-4" style="border-radius: 12px; background: #fff;">
            <div class="card-header bg-white py-3">
                <h5 class="mb-0 text-dark"><i class="fas fa-info-circle text-primary me-2"></i>Details</h5>
            </div>
            <div class="card-body">
                <div class="mb-3 d-flex justify-content-between align-items-center">
                    <span class="text-muted">Due Date</span>
                    <span class="font-weight-bold">{{ assignment.due_date|format_date('%b %d, %H:%M') }}</span>
                </div>
                <div class="mb-3 d-flex justify-content-between align-items-center">
                    <span class="text-muted">Max Points</span>
                    <span class="badge bg-primary rounded-pill">{{ assignment.points }} pts</span>
                </div>
                <div class="d-flex justify-content-between align-items-center">
                    <span class="text-muted">Languages</span>
                    <div>
                        {% for lang in assignment.languages %}
                        <span class="badge bg-light text-dark border">{{ lang }}</span>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Previous Submissions Sidebar -->
        <div class="card border-0 shadow-sm" style="border-radius: 12px; background: #fff;">
            <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                <h5 class="mb-0 text-dark"><i class="fas fa-history text-secondary me-2"></i>History</h5>
                <span class="badge bg-secondary rounded-pill">{{ previous_submissions|length }}</span>
            </div>
            <div class="card-body p-0">
                {% if previous_submissions %}
                <div class="list-group list-group-flush">
                    {% for prev in previous_submissions %}
                    <a href="{{ url_for('student.submission_results', submission_id=prev.get_id()) }}"
                        class="list-group-item list-group-item-action p-3">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">Version {{ prev.version }}</h6>
                            <small class="text-muted">{{ prev.created_at|format_date('%m/%d %H:%M') if prev.created_at
                                else 'N/A' }}</small>
                        </div>
                        <div class="d-flex align-items-center mt-1">
                            <span class="badge bg-light text-dark border me-2 small">{{ prev.language }}</span>
                            {% if prev.score is not none %}
                            <span
                                class="text-{{ 'success' if prev.score >= 80 else 'warning' if prev.score >= 50 else 'danger' }} small font-weight-bold">
                                {{ prev.score }}/100
                            </span>
                            {% endif %}
                        </div>
                    </a>
                    {% endfor %}
                </div>
                {% else %}
                <div class="p-4 text-center text-muted">
                    <i class="fas fa-inbox fa-2x mb-2 d-block opacity-25"></i>
                    <p class="mb-0 small">No previous attempts</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Code Template -->
        <div class="card border-0 shadow-sm mt-4" style="border-radius: 12px; background: #fff;">
            <div class="card-header bg-white py-3">
                <h5 class="mb-0 text-dark"><i class="fas fa-file-code text-info me-2"></i>Code Template</h5>
            </div>
            <div class="card-body">
                <pre id="templateCode" class="bg-light p-2 rounded small mb-2"
                    style="max-height: 150px; overflow-y: auto;">def solve():
    # Write your solution here
    pass

if __name__ == "__main__":
    solve()</pre>
                <button type="button" class="btn btn-outline-info btn-sm w-100" onclick="insertTemplate()">
                    <i class="fas fa-copy me-1"></i>Insert Template
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    // --- Editor Configuration ---
    const codeInput = document.getElementById('code');
    const charCount = document.getElementById('charCount');
    const lineCount = document.getElementById('lineCount');
    const dryRunBtn = document.getElementById('dryRunBtn');
    const hintBtn = document.getElementById('hintBtn');
    const resultsPanel = document.getElementById('resultsPanel');
    const testResultsList = document.getElementById('testResultsList');
    const aiHintContent = document.getElementById('aiHintContent');

    function updateCounts() {
        if (!codeInput) return;
        const text = codeInput.value;
        if (lineCount) lineCount.textContent = text.split('\n').length;
        if (charCount) charCount.textContent = text.length;
    }

    if (codeInput) {
        codeInput.addEventListener('keydown', function (e) {
            if (e.key === 'Tab') {
                e.preventDefault();
                const start = this.selectionStart;
                const end = this.selectionEnd;
                this.value = this.value.substring(0, start) + '\t' + this.value.substring(end);
                this.selectionStart = this.selectionEnd = start + 1;
                updateCounts();
            }
        });
        codeInput.addEventListener('input', updateCounts);
        // Initial count
        updateCounts();
    }

    function formatCode() {
        if (!codeInput) return;
        const lines = codeInput.value.split('\n');
        const formatted = lines.map(line => line.trimEnd()).join('\n');
        codeInput.value = formatted;
        updateCounts();
    }

    function insertTemplate() {
        const template = document.getElementById('templateCode').textContent;
        if (codeInput && confirm('Replace current code with template?')) {
            codeInput.value = template;
            updateCounts();
        }
    }

    function handleFileUpload(input) {
        const file = input.files[0];
        if (!file) return;
        if (file.size > 2 * 1024 * 1024) {
            alert('File size exceeds 2MB limit');
            return;
        }
        document.getElementById('fileName').textContent = file.name;
        const reader = new FileReader();
        reader.onload = function (e) {
            codeInput.value = e.target.result;
            updateCounts();
        };
        reader.readAsText(file);
    }

    function hideResults() {
        if (resultsPanel) resultsPanel.classList.add('d-none');
    }

    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // --- API Interactions ---
    async function runDryRun() {
        if (!codeInput) return;
        const code = codeInput.value;
        const language = document.getElementById('language').value;

        if (!code.trim()) {
            alert('Please write some code first!');
            return;
        }

        if (dryRunBtn) {
            dryRunBtn.disabled = true;
            dryRunBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Running...';
        }
        if (resultsPanel) resultsPanel.classList.remove('d-none');
        if (testResultsList) testResultsList.innerHTML = '<div class="p-5 text-center"><i class="fas fa-cog fa-spin fa-2x text-primary mb-3"></i><p class="text-muted">Executing tests in sandbox...</p></div>';

        const testTabEl = document.getElementById('test-results-tab');
        if (testTabEl) {
            const testTab = new bootstrap.Tab(testTabEl);
            testTab.show();
        }

        try {
            const response = await fetch('/api/test-code', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token() }}'
                },
                body: JSON.stringify({
                    code: code,
                    language: language,
                    assignment_id: {{ assignment.get_id() }}
                })
    });

    const data = await response.json();
    if (data.success) {
        renderTestResults(data);
        if (data.ai_feedback) displayAiHint(data.ai_feedback);
    } else {
        if (testResultsList) testResultsList.innerHTML = `<div class="alert alert-danger m-3">${data.error}</div>`;
    }
        } catch (error) {
        if (testResultsList) testResultsList.innerHTML = `<div class="alert alert-danger m-3">Network error: ${error.message}</div>`;
    } finally {
        if (dryRunBtn) {
            dryRunBtn.disabled = false;
            dryRunBtn.innerHTML = '<i class="fas fa-flask me-1"></i>Test Code';
        }
    }
    }

    async function requestAiHint() {
        if (!codeInput) return;
        const code = codeInput.value;
        if (!code.trim()) {
            alert('Please write some code first!');
            return;
        }

        if (hintBtn) {
            hintBtn.disabled = true;
            hintBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Analyzing...';
        }
        if (resultsPanel) resultsPanel.classList.remove('d-none');
        if (aiHintContent) aiHintContent.innerHTML = '<div class="p-4 text-center"><i class="fas fa-brain fa-spin fa-2x text-warning mb-3"></i><p class="text-muted">AI is analyzing your code logic...</p></div>';

        const hintTabEl = document.getElementById('ai-hint-tab');
        if (hintTabEl) {
            const hintTab = new bootstrap.Tab(hintTabEl);
            hintTab.show();
        }

        try {
            const response = await fetch('/api/hint', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token() }}'
                },
                body: JSON.stringify({ code: code })
            });

            const data = await response.json();
            if (data.success) {
                displayAiHint(data.hint);
            } else {
                if (aiHintContent) aiHintContent.innerHTML = `<div class="alert alert-danger m-3">${data.error}</div>`;
            }
        } catch (error) {
            if (aiHintContent) aiHintContent.innerHTML = `<div class="alert alert-danger m-3">Error: ${error.message}</div>`;
        } finally {
            if (hintBtn) {
                hintBtn.disabled = false;
                hintBtn.innerHTML = '<i class="fas fa-lightbulb me-1"></i>AI Hint';
            }
        }
    }

    function renderTestResults(data) {
        if (!testResultsList) return;
        let html = `
            <div class="px-3 py-2 bg-white border-bottom d-flex justify-content-between align-items-center">
                <span class="font-weight-bold small text-dark">Estimated Score: ${data.score}%</span>
                <span class="badge ${data.passed_count === data.total_count ? 'bg-success' : 'bg-warning'} rounded-pill">
                    ${data.passed_count} / ${data.total_count} Passed
                </span>
            </div>
            <div class="list-group list-group-flush" style="max-height: 400px; overflow-y: auto;">
        `;

        const results = data.test_results || [];
        results.forEach((res, index) => {
            html += `
                <div class="list-group-item p-3 border-bottom">
                    <div class="d-flex w-100 justify-content-between align-items-center">
                        <h6 class="mb-1 ${res.passed ? 'text-success' : 'text-danger'} font-weight-bold small">
                            <i class="fas ${res.passed ? 'fa-check-circle' : 'fa-times-circle'} me-1"></i> Case ${index + 1}: ${res.name}
                        </h6>
                        <small class="text-muted">${res.runtime_ms || 0}ms</small>
                    </div>
                    ${!res.passed ? `
                        <div class="mt-2 small">
                            <div class="bg-light p-2 rounded mb-1 font-monospace" style="font-size: 11px;">
                                <span class="text-muted">Expected:</span> <span class="text-dark">${escapeHtml(res.expected || 'N/A')}</span>
                            </div>
                            <div class="bg-light p-2 rounded font-monospace" style="font-size: 11px;">
                                <span class="text-muted">Actual:</span> <span class="text-danger">${escapeHtml(res.actual || res.output || 'No output')}</span>
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
        });

        html += '</div>';
        testResultsList.innerHTML = html;
    }

    function displayAiHint(hint) {
        if (!aiHintContent) return;
        aiHintContent.innerHTML = `
            <div class="d-flex align-items-start gap-3">
                <div class="text-warning"><i class="fas fa-robot fa-2x"></i></div>
                <div>
                    <h6 class="font-weight-bold mb-2">AI Logic Guidance</h6>
                    <div class="text-dark small" style="white-space: pre-wrap; line-height: 1.6;">${escapeHtml(hint)}</div>
                    <div class="mt-3 p-2 bg-light rounded small text-muted">
                        <i class="fas fa-info-circle me-1"></i>Hints are generated based on your current code.
                    </div>
                </div>
            </div>
        `;
    }
</script>

<!-- Autosave logic -->
<script src="{{ url_for('static', filename='js/submission_autosave.js') }}"></script>
<script>
    window.AUTOSAVE_CONFIG = {
        assignmentId: {{ assignment.get_id() }},
    csrfToken: '{{ csrf_token() }}',
        intervalMs: 15000
    };
</script>

<style>
    .code-editor-textarea:focus {
        background: #fff !important;
        border-color: #667eea;
        box-shadow: 0 0 0 0.25rem rgba(102, 126, 234, 0.1);
    }

    .nav-tabs .nav-link {
        border: none;
        color: #6c757d;
        font-weight: 500;
        border-bottom: 2px solid transparent;
    }

    .nav-tabs .nav-link.active {
        color: #667eea;
        background: transparent;
        border-bottom: 2px solid #667eea;
    }

    .autosave-status {
        font-size: 0.8rem;
        font-weight: 600;
    }

    .autosave-status.ok {
        color: #198754;
    }

    .autosave-status.saving {
        color: #0d6efd;
    }

    .autosave-status.error {
        color: #dc3545;
    }

    /* Scrollbar styling for editor */
    .code-editor-textarea::-webkit-scrollbar {
        width: 8px;
    }

    .code-editor-textarea::-webkit-scrollbar-track {
        background: #f1f1f1;
    }

    .code-editor-textarea::-webkit-scrollbar-thumb {
        background: #ccc;
        border-radius: 4px;
    }

    .code-editor-textarea::-webkit-scrollbar-thumb:hover {
        background: #bbb;
    }
</style>
{% endblock %}